# 1) Keep a supported backend here (OVN is not a valid value)
network:
  backend:
    - openvswitch

# 2) Ensure the init Jobs and components you need are rendered
manifests:
  job_db_init: true
  job_db_sync: true
  job_ks_user: true
  job_ks_service: true
  job_ks_endpoints: true
  job_rabbit_init: true

  deployment_server: true
  service_server: true

  # OVN path only (no legacy OVS/L3/DHCP agents)
  daemonset_ovn_metadata: true
  daemonset_openvswitch_agent: false
  daemonset_linuxbridge_agent: false
  daemonset_sriov_agent: false
  daemonset_dhcp_agent: false
  daemonset_l3_agent: false
  daemonset_metadata_agent: false

# 3) Neutron config (ML2/OVN)
conf:
  neutron:
    DEFAULT:
      core_plugin: ml2
      service_plugins:
        networking_ovn:
          l3:
            l3_ovn: OVNL3RouterPlugin
      global_physnet_mtu: 1500
    ml2:
      mechanism_drivers: ovn
      type_drivers: geneve,flat,vlan
      tenant_network_types: geneve
      extension_drivers: port_security
    ml2_type_geneve:
      vni_ranges: 1:10000
    ml2_type_flat:
      flat_networks: physnet1
    ml2_type_vlan:
      network_vlan_ranges: physnet1:100:200
    ovn:
      ovn_metadata_enabled: true
    oslo_concurrency:
      lock_path: /var/lib/neutron/tmp

  # IMPORTANT: this is the exact path the template reads:
  # .Values.conf.plugins.ml2_conf.ovn.{ovn_nb_connection, ovn_sb_connection, bridge_mappings}
  plugins:
    ml2_conf:
      ml2:
        mechanism_drivers: ovn
        type_drivers: geneve,flat,vlan
      ovn:
        # Use placeholders; the chartâ€™s init script replaces them with ClusterIPs
        # because Neutron does not accept DNS names here.
        ovn_nb_connection: "tcp:__OVN_NB_DB_SERVICE_HOST__:__OVN_NB_DB_SERVICE_PORT__"
        ovn_sb_connection: "tcp:__OVN_SB_DB_SERVICE_HOST__:__OVN_SB_DB_SERVICE_PORT__"
        bridge_mappings: "physnet1:br-ex"

# 4) Endpoints must be at the TOP LEVEL (not under a 'neutron:' key)
endpoints:
  identity:
    hosts: { default: keystone-api, internal: keystone-api }
    namespace: openstack
    scheme: { default: http }
    port:
      api: { default: 80, internal: 5000 }
    path: { default: /v3 }
    auth:
      admin:   { region_name: RegionOne, username: admin,        project_name: admin,   user_domain_name: Default, project_domain_name: Default }
      neutron: { region_name: RegionOne, username: neutron,      project_name: service, user_domain_name: Default, project_domain_name: Default }
      nova:    { region_name: RegionOne, username: nova_neutron, project_name: service, user_domain_name: Default, project_domain_name: Default }

  oslo_db:
    hosts: { default: mariadb }
    namespace: osh-infra
    scheme: mysql+pymysql
    path: /neutron
    port: { mysql: { default: 3306 } }
    auth:
      admin:   { username: root }
      neutron: { username: neutron }

  oslo_messaging:
    host_fqdn_overrides: { default: rabbitmq.osh-infra.svc.cluster.local }
    hosts: { default: rabbitmq }
    namespace: osh-infra
    scheme: rabbit
    path: /neutron
    port:
      amqp: { default: 5672 }
      http: { default: 15672 }
    auth:
      admin:   { username: rabbitmq }
      neutron: { username: neutron }

  oslo_cache:
    host_fqdn_overrides: { default: memcached.osh-infra.svc.cluster.local }
    hosts: { default: memcached }
    namespace: osh-infra
    port:
      memcache: { default: 11211 }

# 5) (Optional) Entrypoint deps that point to osh-infra for memcached
dependencies:
  static:
    neutron_server:
      service:
        - { endpoint: memcached, namespace: osh-infra }
      job:
        - { name: neutron-ks-user,      namespace: openstack }
        - { name: neutron-ks-endpoints, namespace: openstack }
        - { name: neutron-db-sync,      namespace: openstack }
        - { name: neutron-rabbit-init,  namespace: openstack }
    neutron_rpc_server:
      service:
        - { endpoint: memcached, namespace: osh-infra }
      job:
        - { name: neutron-ks-user,      namespace: openstack }
        - { name: neutron-ks-endpoints, namespace: openstack }
        - { name: neutron-db-sync,      namespace: openstack }
        - { name: neutron-rabbit-init,  namespace: openstack }
