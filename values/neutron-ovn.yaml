# Keep a supported backend here; OVN is driven by ML2 + ovn options
network:
  backend:
    - openvswitch

manifests:
  job_bootstrap: true
  job_db_init: true
  job_db_sync: true
  job_ks_user: true
  job_ks_service: true
  job_ks_endpoints: true
  job_rabbit_init: true

  deployment_server: true
  deployment_rpc_server: true
  service_server: true
  ingress_server: false

  # OVN only (no legacy agents)
  daemonset_ovn_metadata: true
  daemonset_ovs_agent: false
  daemonset_linuxbridge_agent: false
  daemonset_sriov_agent: false
  daemonset_dhcp_agent: false
  daemonset_l3_agent: false
  daemonset_metadata_agent: false

labels:
  agent:
    dhcp:
      node_selector_key: openstack-control-plane
      node_selector_value: enabled
    l3:
      node_selector_key: openstack-control-plane
      node_selector_value: enabled
    metadata:
      node_selector_key: openstack-control-plane
      node_selector_value: enabled
    l2gw:
      node_selector_key: openstack-control-plane
      node_selector_value: enabled
    ovn_vpn:
      node_selector_key: openstack-control-plane
      node_selector_value: enabled
    ovn_metadata:
      node_selector_key: openstack-compute-node
      node_selector_value: enabled
  job:
    node_selector_key: openstack-control-plane
    node_selector_value: enabled
  lb:
    node_selector_key: linuxbridge
    node_selector_value: enabled
  ovs:
    node_selector_key: openvswitch
    node_selector_value: enabled
  sriov:
    node_selector_key: sriov
    node_selector_value: enabled
  bagpipe_bgp:
    node_selector_key: openstack-compute-node
    node_selector_value: enabled
  bgp_dragent:
    node_selector_key: openstack-compute-node
    node_selector_value: enabled

conf:
  neutron:
    DEFAULT:
      core_plugin: ml2
      # IMPORTANT for OVN:
      service_plugins: networking_ovn.l3.l3_ovn.OVNL3RouterPlugin
      global_physnet_mtu: 1500
    ml2:
      mechanism_drivers: ovn
      type_drivers: geneve,flat,vlan
      tenant_network_types: geneve
      extension_drivers: port_security
    ml2_type_geneve:
      vni_ranges: 1:10000
    ml2_type_flat:
      flat_networks: physnet1
    ml2_type_vlan:
      network_vlan_ranges: physnet1:100:200
    ovn:
      ovn_metadata_enabled: true
    oslo_concurrency:
      lock_path: /var/lib/neutron/tmp

  # EXACT path the chart reads in its OVN init script:
  plugins:
    ml2_conf:
      ml2:
        mechanism_driver: ovn
      ovn:
        # Chart replaces these placeholders with the NB/SB Service ClusterIPs/ports
        ovn_nb_connection: "tcp:__OVN_NB_DB_SERVICE_HOST__:__OVN_NB_DB_SERVICE_PORT__"
        ovn_sb_connection: "tcp:__OVN_SB_DB_SERVICE_HOST__:__OVN_SB_DB_SERVICE_PORT__"
        bridge_mappings: "physnet1:br-ex"


# Let entrypoint look in the right namespaces while waiting
dependencies:
  static:
    neutron_server:
      service:
        - { endpoint: memcached, namespace: osh-infra }
      job:
        - { name: neutron-ks-user,      namespace: openstack }
        - { name: neutron-ks-endpoints, namespace: openstack }
        - { name: neutron-db-sync,      namespace: openstack }
        - { name: neutron-rabbit-init,  namespace: openstack }
    neutron_rpc_server:
      service:
        - { endpoint: memcached, namespace: osh-infra }
      job:
        - { name: neutron-ks-user,      namespace: openstack }
        - { name: neutron-ks-endpoints, namespace: openstack }
        - { name: neutron-db-sync,      namespace: openstack }
        - { name: neutron-rabbit-init,  namespace: openstack }
